---
import BaseForm from '@/components/molecules/BaseForm/BaseForm.astro'
import FormFieldArea from '@/components/molecules/FormFieldArea/FormFieldArea.astro'

const fields = [
  {
    label: { text: 'åå‰', required: true },
    id: 'name',
    type: 'text',
    placeholder: 'å±±ç”°å¤ªéƒ',
    autocomplete: 'name',
    icon: 'mdi:user',
    validations: [{ pattern: /^(?!s*$).+/, text: 'åå‰ã¯å¿…é ˆã§ã™' }],
    '@change': '$refs.kana.dispatchEvent(new Event("input"))', // AutoKanaã®çµæœã‚’è©•ä¾¡ã™ã‚‹ãŸã‚
    '@blur': '$refs.kana.dispatchEvent(new Event("input"))', // AutoKanaã®çµæœã‚’è©•ä¾¡ã™ã‚‹ãŸã‚
  },
  {
    label: { text: 'ãƒ•ãƒªã‚¬ãƒŠ', required: true },
    id: 'kana',
    type: 'text',
    placeholder: 'ãƒ¤ãƒãƒ€ã‚¿ãƒ­ã‚¦',
    validations: [
      { pattern: /^(?!s*$).+/, text: 'ã‚«ãƒŠã¯å¿…é ˆã§ã™' },
      { pattern: /^[ã‚¡-ãƒ¶ãƒ¼]+$/, text: 'ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„' },
    ],
    'x-ref': 'kana', // AutoKanaã®çµæœã‚’è©•ä¾¡ã•ã›ã‚‹ãŸã‚
  },
  {
    label: { text: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', required: true },
    id: 'email',
    type: 'email',
    placeholder: 'taro.yamada@example.com',
    autocomplete: 'email',
    icon: 'mdi:email',
    validations: [
      { pattern: /^(?!s*$).+/, text: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™' },
      { pattern: /^[\w\.-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, text: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„' },
    ],
  },
  {
    label: { text: 'å•ã„åˆã‚ã›å†…å®¹', required: true },
    id: 'message',
    type: 'textarea',
    placeholder: 'ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
    validations: [{ pattern: /^(?!s*$).+/, text: 'ãŠå•ã„åˆã‚ã›å†…å®¹ã¯å¿…é ˆã§ã™' }],
  },
  {
    label: null,
    id: 'privacy',
    type: 'checkbox',
    items: ['<a href="/privacy/" class="link" tabindex="-1" target="_blank">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã™ã‚‹'],
    validations: [
      {
        pattern: 'this.privacy.length',
        text: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã„ãŸã ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚',
      },
    ],
  },
]

const api = import.meta.env.PUBLIC_API_BASE_URL
---

<BaseForm {fields} steps={['å…¥åŠ›', 'ç¢ºèª', 'å®Œäº†']} hx-post={`${api}/mail/send`} @success="step = 3">
  <div x-show="step == 1" id="contact">
    <FormFieldArea {fields} turnstyle={true} />
    <div class="mt-6">
      <button
        type="button"
        class="btn btn-disabled btn-primary w-full"
        x-bind:class="{'btn-disabled': Object.keys(errors).length}"
        x-on:click="if(!Object.keys(errors).length){step = 2}"
      >
        å…¥åŠ›å†…å®¹ã®ç¢ºèª
      </button>
    </div>
  </div>

  <div x-show="step == 2">
    <FormFieldArea {fields} mode="confirm" />
    <div class="mt-6 grid gap-4 md:grid-cols-2">
      <button
        class="btn btn-disabled btn-accent w-full md:order-2"
        x-bind:class="{'btn-disabled': Object.keys(errors).length}"
        x-on:click="if(!Object.keys(errors).length){ return true }"
      >
        ãŠå•ã„åˆã‚ã›ã‚’é€ä¿¡
      </button>
      <button type="button" class="btn btn-ghost w-full md:order-1" x-on:click="step = 1">å…¥åŠ›å†…å®¹ã®ä¿®æ­£</button>
    </div>
  </div>

  <div x-show="step == 3">
    <p>ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰âœ¨</p>
    <p>
      ã“ã®åº¦ã¯ãŠå•ã„åˆã‚ã›ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br />
      å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã—ã€æŠ˜ã‚Šè¿”ã—ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚<br />
      ã¾ãŸã€å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸è‡ªå‹•è¿”ä¿¡ãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€ã”ç¢ºèªãã ã•ã„ã€‚
    </p>
  </div>
</BaseForm>

<script>
  import * as AutoKana from 'vanilla-autokana'
  document.addEventListener('astro:page-load', () => {
    if (window.location.pathname === '/contact/') {
      AutoKana.bind('#name', '#kana', { katakana: true })
    }
  })
</script>
